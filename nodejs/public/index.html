<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>발표가 체질</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Global font and basic reset */
        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            background-color: #f0f4f8; /* Light blue-gray background to match image mood */
            color: #333;
        }

        /* Navigation Bar Styling - Adapted to match image_f687f1.png */
        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0; /* Subtle border */
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        /* Note: For .navbar-brand and .nav-link styles, ensure your custom CSS is defined AFTER Bootstrap's or use !important if needed to override. */
        .navbar-brand {
            font-family: 'Orbitron', sans-serif; /* Using font from the first HTML */
            font-size: 1.8rem; /* Adjusted for consistency */
            font-weight: 700;
            color: #333;
        }

        .navbar-brand .text-primary {
            color: #007bff !important; /* Specific blue color from the image */
        }

        .navbar-nav .nav-link {
            color: #666; /* Softer color for links */
            font-weight: 500;
            padding: 5px 0;
            position: relative;
            transition: color 0.2s ease;
            /* margin-left: 15px; */ /* Bootstrap's gap-3 on ul handles spacing now */
        }

        .navbar-nav .nav-link:hover {
            color: #007bff; /* Hover color matches the blue in the brand */
        }

        .navbar-nav .nav-link.active {
            color: #007bff !important; /* Active link color matches the blue in the brand */
            font-weight: 700;
        }

        /* Container for the main content */
        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 90%; /* 화면 너비의 90%를 사용하도록 설정합니다. */
            margin: 50px auto;
            box-sizing: border-box;
            border: 1px solid #e0e0e0;
        }

        /* Responsive adjustment for wider screens */
        @media (min-width: 1200px) {
            .container {
                width: 80%; /* Further widen for large screens */
            }
        }

        h1 {
            color: #007bff; /* Blue color for main title */
            text-align: center;
            margin-bottom: 20px; /* Reduced margin below h1 */
            font-size: 32px; /* Larger font size for main title */
            font-weight: 700; /* Bolder */
        }
        .container > p { /* Styling for the introductory paragraph */
            text-align: center;
            color: #555;
            font-size: 16px;
            margin-bottom: 30px;
        }

        /* Input and button styling (main content) */
        input#audioFileInput {
            border: 1px solid #ccddee; /* Softer blueish border */
            padding: 12px; /* Increased padding */
            border-radius: 8px; /* More rounded */
            width: calc(100% - 24px); /* Adjusted width for padding */
            margin-bottom: 25px; /* More space below input */
            box-sizing: border-box;
        }

        /* --- Button Styling (Updated) --- */
        .button-group {
            display: flex; /* Arrange buttons in a row */
            justify-content: center; /* Center the buttons */
            gap: 10px; /* Space between buttons */
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            margin-bottom: 12px; /* Space below the button group */
        }

        .action-button {
            background-color: #6c63ff; /* Primary color from your original design */
            color: white;
            padding: 10px 20px; /* Smaller padding for a more compact look */
            border: none;
            border-radius: 25px; /* Pill shape for a cuter look */
            cursor: pointer;
            font-size: 1rem; /* Slightly smaller font size */
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 8px rgba(108, 99, 255, 0.2); /* Shadow with primary color */
            flex-grow: 1; /* Allow buttons to grow and fill space */
            max-width: 220px; /* Max width to keep them from getting too wide */
        }

        .action-button:hover {
            background-color: #4a42e6; /* Darker primary on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3);
        }

        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(108, 99, 255, 0.2);
        }
        /* --- End Button Styling --- */


        /* Result and loading styling */
        #result {
            margin-top: 35px; /* Increased margin */
            padding: 25px; /* More padding */
            border: 1px solid #e0e0e0;
            border-radius: 10px; /* Slightly more rounded */
            background-color: #fbfdff; /* Very light blue background for result */
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
        }
        #result h2 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px; /* Space below h2 */
            font-size: 26px; /* Larger for result heading */
        }
        #result p { margin: 8px 0; line-height: 1.6; }
        #similarityScore { font-size: 26px; font-weight: bold; color: #007bff; }
        #feedbackMessage { font-size: 19px; color: #28a745; font-weight: 600; }
        #detail { color: #6c757d; font-size: 15px;}

        .loading { text-align: center; margin-top: 25px; font-style: italic; color: #555; }

        /* Waveform container styling */
        #waveform-container,
        #standard-waveform-container,
        #overlapped-waveform-container {
            margin-top: 30px; /* Increased margin */
            padding: 20px; /* Increased padding */
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); /* Consistent shadow */
        }

        #standard-waveform-container {
            border: 1px solid #d8e2ed; /* Lighter, subtle border */
            background-color: #eef4f8; /* Softer gray-blue */
        }

        #waveform-container {
            border: 1px solid #a8cde6; /* Clearer blue border */
            background-color: #eaf3fb; /* Lighter blue */
        }

        #overlapped-waveform-container {
            border: 1px solid #007bff; /* Primary blue border */
            background-color: #e6f3ff; /* Primary light blue background */
        }

        /* Styles for the canvas element */
        #overlapped-waveform-canvas {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            border-radius: 6px;
            border: 1px solid #eee; /* Optional: add a border to the canvas */
        }

    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light py-3">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold fs-3" href="#">Speechy<span class="text-primary">AI</span></a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center gap-3">
                <li class="nav-item"><a class="nav-link active" href="https://alb.seoyoung.store/index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="https://alb.seoyoung.store/aifeedback.html">AIFeedback</a></li>
                <li class="nav-item"><a class="nav-link" href="http://13.250.114.125:8000/">AI유사도 분석</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <h1>AI와의 발표 유사도 분석</h1>
    <p>비교할 오디오 파일을 업로드해주세요. 업로드된 파일은 표준 AI 음성 파일과 비교됩니다.</p>
    <input type="file" id="audioFileInput" accept="audio/*">

    <div class="button-group">
        <button class="action-button" onclick="generateWaveform()">업로드된 파일 파형 보기</button>
        <button class="action-button" onclick="generateOverlappedWaveform()">겹쳐진 파형 보기</button>
        <button class="action-button" onclick="uploadAndAnalyze()">유사도 분석 시작</button>
    </div>
    <div id="loading" class="loading" style="display:none;">
        분석 중입니다... 잠시만 기다려주세요.
    </div>

    <div id="standard-waveform-container" style="display:none;">
        <h2>표준 오디오 파형</h2>
        <img id="standard-waveform-image" src="" alt="표준 오디오 파형">
        <div id="standard-waveform-loading" class="loading" style="display:block;">
            표준 파형 로딩 중...
        </div>
    </div>

    <div id="waveform-container" style="display:none;">
        <h2>업로드된 오디오 파형</h2>
        <img id="waveform-image" src="" alt="업로드된 오디오 파형">
    </div>

    <div id="overlapped-waveform-container" style="display:none;">
        <h2>겹쳐진 오디오 파형</h2>
        <canvas id="overlapped-waveform-canvas"></canvas>
        </div>

    <div id="result" style="display:none;">
        <h2>🎤 발표 피드백 결과</h2>
        <p id="similarityScore" style="font-size: 22px; font-weight: bold;">유사도 점수: -</p>
        <p id="feedbackMessage" style="font-size: 18px; color: #007bff;">메시지: -</p>
        <p id="detail" style="color: #555;">상세 분석: -</p>
    </div>
</div>

<div id="customMessageBox" style="display:none;">
    <h3 id="customMessageTitle"></h3>
    <p id="customMessageContent"></p>
    <button onclick="this.parentNode.style.display='none'">확인</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });
    });

    // Global variables to cache the image URLs and the last uploaded file
    let cachedUploadedWaveformUrl = null;
    let cachedStandardWaveformUrl = null;
    let lastUploadedFile = null; // To check if the uploaded file has changed

    /**
     * Helper function to load an image
     * @param {string} url - The URL of the image to load
     * @returns {Promise<HTMLImageElement>} A promise that resolves with the loaded image
     */
    function loadImage(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
            img.src = url;
        });
    }

    /**
     * Loads and displays the standard audio waveform image from the server.
     * @returns {Promise<boolean>} True if the waveform was loaded successfully, false otherwise.
     */
    async function loadStandardWaveform() {
        const standardWaveformContainer = document.getElementById('standard-waveform-container');
        const standardWaveformImage = document.getElementById('standard-waveform-image');
        const standardWaveformLoading = document.getElementById('standard-waveform-loading');

        // If already cached, just use it
        if (cachedStandardWaveformUrl) {
            standardWaveformImage.src = cachedStandardWaveformUrl;
            standardWaveformLoading.style.display = 'none';
            standardWaveformContainer.style.display = 'block';
            console.log('캐시된 표준 파형 이미지를 사용합니다.');
            return true;
        }

        // Show loading indicator and hide container initially
        standardWaveformLoading.style.display = 'block';
        standardWaveformContainer.style.display = 'none';
        standardWaveformImage.src = ''; // Clear previous image

        try {
            const response = await fetch('/get_standard_waveform');
            if (!response.ok) {
                const errorData = await response.json();
                console.error('Failed to load standard waveform:', errorData.detail || errorData.error || response.statusText);
                displayCustomMessage('오류', '표준 파형을 불러오는 데 실패했습니다.', 'danger');
                return false;
            }
            const blob = await response.blob();
            const imageUrl = URL.createObjectURL(blob);
            standardWaveformImage.src = imageUrl;

            // Cache the URL
            cachedStandardWaveformUrl = imageUrl;

            // Wait for the image to load before hiding the loading indicator
            await new Promise(resolve => { standardWaveformImage.onload = resolve; });

            standardWaveformLoading.style.display = 'none';
            standardWaveformContainer.style.display = 'block'; // Show container on success
            return true;

        } catch (error) {
            console.error('Error loading standard waveform:', error);
            displayCustomMessage('오류', `표준 파형을 불러오는 데 실패했습니다: ${error.message}`, 'danger');
            standardWaveformContainer.style.display = 'none';
            standardWaveformLoading.style.display = 'none';
            return false;
        }
    }

    /**
     * Generates and displays the waveform for the uploaded audio file.
     * @returns {Promise<boolean>} True if the waveform was loaded successfully, false otherwise.
     */
    async function generateWaveform() {
        const audioFileInput = document.getElementById('audioFileInput');
        const waveformContainer = document.getElementById('waveform-container');
        const waveformImage = document.getElementById('waveform-image');
        const loadingDiv = document.getElementById('loading');
        document.getElementById('result').style.display = 'none';
        document.getElementById('overlapped-waveform-container').style.display = 'none';

        const file = audioFileInput.files?.[0];
        if (!file) {
            displayCustomMessage('알림', '오디오 파일을 선택해주세요.', 'info');
            return false;
        }

        // If the file is the same and already cached, just display
        if (lastUploadedFile && lastUploadedFile.name === file.name && lastUploadedFile.size === file.size && cachedUploadedWaveformUrl) {
            waveformImage.src = cachedUploadedWaveformUrl;
            waveformContainer.style.display = 'block';
            console.log('캐시된 업로드된 파형 이미지를 사용합니다.');
            return true;
        }

        loadingDiv.style.display = 'block';
        waveformContainer.style.display = 'none';
        waveformImage.src = '';

        const formData = new FormData();
        formData.append('audioFile', file);

        try {
            const response = await fetch('/get_waveform', {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || errorData.error || '파형 로딩 실패');
            }

            const blob = await response.blob();
            const imageUrl = URL.createObjectURL(blob);
            waveformImage.src = imageUrl;

            // Cache the URL and the file object
            cachedUploadedWaveformUrl = imageUrl;
            lastUploadedFile = file;

            waveformContainer.style.display = 'block';
            return true;

        } catch (error) {
            console.error('Error generating waveform:', error);
            displayCustomMessage('오류', `파형을 불러오는 데 실패했습니다: ${error.message}`, 'danger');
            waveformContainer.style.display = 'none';
            cachedUploadedWaveformUrl = null; // Clear cache on error
            lastUploadedFile = null;
            return false;
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    /**
     * Draws two images onto a canvas, one on top of the other.
     * @param {HTMLImageElement} image1 - The base image (e.g., standard waveform)
     * @param {HTMLImageElement} image2 - The overlay image (e.g., uploaded waveform)
     * @param {HTMLCanvasElement} canvas - The canvas element to draw on
     */
    function drawOverlappedWaveformOnCanvas(image1, image2, canvas) {
        // Set canvas dimensions to match the largest image
        const maxWidth = Math.max(image1.width, image2.width);
        const maxHeight = Math.max(image1.height, image2.height);

        canvas.width = maxWidth;
        canvas.height = maxHeight;

        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

        // Draw image1 (standard waveform)
        ctx.drawImage(image1, 0, 0, maxWidth, maxHeight); // Stretch to fill canvas

        // Draw image2 (uploaded waveform) with a semi-transparent overlay
        // You can adjust globalAlpha for more or less transparency
        ctx.globalAlpha = 0.7; // Example: 70% opacity for the second image
        ctx.drawImage(image2, 0, 0, maxWidth, maxHeight); // Stretch to fill canvas
        ctx.globalAlpha = 1.0; // Reset alpha for future drawings
    }


    /**
     * Generates and displays an overlapped waveform using cached images and canvas.
     */
    async function generateOverlappedWaveform() {
        const audioFileInput = document.getElementById('audioFileInput');
        const overlappedWaveformContainer = document.getElementById('overlapped-waveform-container');
        const overlappedWaveformCanvas = document.getElementById('overlapped-waveform-canvas');
        const loadingDiv = document.getElementById('loading');

        // Hide other result and waveform containers
        document.getElementById('result').style.display = 'none';
        document.getElementById('waveform-container').style.display = 'none';
        document.getElementById('standard-waveform-container').style.display = 'none';

        const file = audioFileInput.files?.[0];
        if (!file) {
            displayCustomMessage('알림', '오디오 파일을 선택해주세요.', 'info');
            return;
        }

        loadingDiv.style.display = 'block';
        overlappedWaveformContainer.style.display = 'none';

        try {
            // Ensure both waveforms are loaded and cached
            const standardLoaded = await loadStandardWaveform();
            const uploadedLoaded = await generateWaveform(); // This also loads/caches the uploaded waveform

            if (!standardLoaded || !uploadedLoaded) {
                // If either failed to load, display an error and return
                displayCustomMessage('오류', '겹쳐진 파형을 생성하기 위해 두 파형이 모두 필요합니다. 다시 시도해주세요.', 'danger');
                return;
            }

            // Now that we're sure the URLs are cached, load the images
            const standardImage = await loadImage(cachedStandardWaveformUrl);
            const uploadedImage = await loadImage(cachedUploadedWaveformUrl);

            // Draw them onto the canvas
            drawOverlappedWaveformOnCanvas(standardImage, uploadedImage, overlappedWaveformCanvas);
            overlappedWaveformContainer.style.display = 'block'; // Show overlapped waveform container

            console.log('클라이언트 측에서 겹쳐진 파형을 성공적으로 생성했습니다.');

        } catch (error) {
            console.error('Error generating overlapped waveform on canvas:', error);
            displayCustomMessage('오류', `겹쳐진 파형을 불러오는 데 실패했습니다: ${error.message}`, 'danger');
            overlappedWaveformContainer.style.display = 'none';
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    /**
     * Displays a custom message box instead of the browser's native alert.
     * @param {string} title - The title of the message box.
     * @param {string} message - The main content message.
     * @param {string} type - The type of message ('info', 'success', 'danger') to influence styling.
     */
    function displayCustomMessage(title, message, type = 'info') {
        let messageBox = document.getElementById('customMessageBox');
        if (!messageBox) {
            // Create message box element if it doesn't exist
            messageBox = document.createElement('div');
            messageBox.id = 'customMessageBox';
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                max-width: 400px;
                text-align: center;
                display: none; /* Hidden by default */
                flex-direction: column;
                gap: 15px;
            `;
            document.body.appendChild(messageBox);

            // Add title element
            const messageTitle = document.createElement('h3');
            messageTitle.id = 'customMessageTitle';
            messageBox.appendChild(messageTitle);

            // Add content element
            const messageContent = document.createElement('p');
            messageContent.id = 'customMessageContent';
            messageBox.appendChild(messageContent);

            // Add close button
            const closeButton = document.createElement('button');
            closeButton.textContent = '확인';
            closeButton.onclick = () => messageBox.style.display = 'none'; // Hide on click
            closeButton.style.cssText = `
                background-color: #007bff;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin-top: 10px;
            `;
            messageBox.appendChild(closeButton);
        }

        // Set content and style based on parameters
        const titleElem = document.getElementById('customMessageTitle');
        const contentElem = document.getElementById('customMessageContent');
        titleElem.textContent = title;
        contentElem.textContent = message;

        let borderColor, backgroundColor;
        switch (type) {
            case 'info':
                borderColor = '#007bff';
                backgroundColor = '#e6f3ff';
                break;
            case 'success':
                borderColor = '#28a745';
                backgroundColor = '#e6ffe6';
                break;
            case 'danger':
                borderColor = '#dc3545';
                backgroundColor = '#ffe6e6';
                break;
            default:
                borderColor = '#007bff';
                backgroundColor = '#e6f3ff';
        }
        messageBox.style.borderColor = borderColor;
        messageBox.style.backgroundColor = backgroundColor;
        messageBox.style.border = `1px solid ${borderColor}`;

        messageBox.style.display = 'flex'; // Show the message box
    }

</script>
</body>
</html>