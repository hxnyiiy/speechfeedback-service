<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œí‘œê°€ ì²´ì§ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Global font and basic reset */
        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            background-color: #f0f4f8; /* Light blue-gray background to match image mood */
            color: #333;
        }

        /* Navigation Bar Styling - Adapted from the first HTML's navbar, using Bootstrap classes */
        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0; /* Subtle border */
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-brand {
            font-family: 'Orbitron', sans-serif; /* Using font from the first HTML */
            font-size: 1.8rem; /* Adjusted for consistency */
            font-weight: 700;
            color: #333;
        }

        .navbar-brand .text-primary {
            color: #6c63ff !important; /* Specific primary color from the first HTML */
        }

        .navbar-nav .nav-link {
            color: #666; /* Softer color for links */
            font-weight: 500;
            padding: 5px 0;
            position: relative;
            transition: color 0.2s ease;
            margin-left: 15px; /* Spacing between links */
        }

        .navbar-nav .nav-link:hover {
            color: #6c63ff; /* Hover color from the first HTML's primary */
        }

        .navbar-nav .nav-link.active {
            color: #6c63ff !important; /* Active link color */
            font-weight: 700;
        }

        /* Container for the main content */
        .container {
            background-color: #ffffff; /* White background for the main card */
            padding: 40px; /* Increased padding */
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); /* Softer, more prominent shadow */
            max-width: 800px;
            margin: 0px auto; /* More margin from top/bottom */
            box-sizing: border-box;
            border: 1px solid #e0e0e0; /* Subtle border for the container */
        }

        h1 {
            color: #007bff; /* Blue color for main title */
            text-align: center;
            margin-bottom: 20px; /* Reduced margin below h1 */
            font-size: 32px; /* Larger font size for main title */
            font-weight: 700; /* Bolder */
        }
        .container > p { /* Styling for the introductory paragraph */
            text-align: center;
            color: #555;
            font-size: 16px;
            margin-bottom: 30px;
        }

        /* Input and button styling (main content) */
        input#audioFileInput {
            border: 1px solid #ccddee; /* Softer blueish border */
            padding: 12px; /* Increased padding */
            border-radius: 8px; /* More rounded */
            width: calc(100% - 24px); /* Adjusted width for padding */
            margin-bottom: 25px; /* More space below input */
            box-sizing: border-box;
        }
        button {
            background-color: #007bff; /* Vibrant blue */
            color: white;
            padding: 14px 20px; /* Larger padding for buttons */
            border: none;
            border-radius: 8px; /* Consistent rounded corners */
            cursor: pointer;
            font-size: 17px; /* Slightly larger font */
            font-weight: 600; /* Bolder text */
            width: 100%;
            margin-bottom: 12px; /* Space between buttons */
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2); /* Subtle blue shadow */
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px); /* More noticeable lift */
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); /* Enhanced shadow on hover */
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
        }

        /* Result and loading styling */
        #result {
            margin-top: 35px; /* Increased margin */
            padding: 25px; /* More padding */
            border: 1px solid #e0e0e0;
            border-radius: 10px; /* Slightly more rounded */
            background-color: #fbfdff; /* Very light blue background for result */
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
        }
        #result h2 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px; /* Space below h2 */
            font-size: 26px; /* Larger for result heading */
        }
        #result p { margin: 8px 0; line-height: 1.6; }
        #similarityScore { font-size: 26px; font-weight: bold; color: #007bff; }
        #feedbackMessage { font-size: 19px; color: #28a745; font-weight: 600; }
        #detail { color: #6c757d; font-size: 15px;}

        .loading { text-align: center; margin-top: 25px; font-style: italic; color: #555; }

        /* Waveform container styling */
        #waveform-container,
        #standard-waveform-container,
        #overlapped-waveform-container {
            margin-top: 30px; /* Increased margin */
            padding: 20px; /* Increased padding */
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); /* Consistent shadow */
        }

        #standard-waveform-container {
            border: 1px solid #d8e2ed; /* Lighter, subtle border */
            background-color: #eef4f8; /* Softer gray-blue */
        }

        #waveform-container {
            border: 1px solid #a8cde6; /* Clearer blue border */
            background-color: #eaf3fb; /* Lighter blue */
        }

        #overlapped-waveform-container {
            border: 1px solid #007bff; /* Primary blue border */
            background-color: #e6f3ff; /* Primary light blue background */
        }

        #waveform-image,
        #standard-waveform-image,
        #overlapped-waveform-image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            border-radius: 6px; /* Slightly more rounded images */
        }

        /* Custom Message Box Styles */
        #customMessageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px 40px; /* More padding */
            border-radius: 16px; /* Even more rounded */
            box-shadow: 0 8px 30px rgba(0,0,0,0.3); /* Stronger, softer shadow */
            z-index: 1000;
            max-width: 500px; /* Wider */
            text-align: center;
            display: none;
            flex-direction: column;
            gap: 25px; /* More space */
            border: 3px solid; /* Thicker border */
        }

        #customMessageBox h3 {
            margin-top: 0;
            font-size: 22px; /* Larger title */
            color: #333;
        }
        #customMessageBox p {
            font-size: 17px; /* Larger text */
            color: #555;
            margin-bottom: 0;
        }
        #customMessageBox button {
            width: auto;
            align-self: center;
            padding: 12px 35px; /* Larger button */
            border-radius: 25px; /* Pill-shaped button */
        }
        #customMessageBox.info { border-color: #007bff; background-color: #e6f3ff; }
        #customMessageBox.success { border-color: #28a745; background-color: #e6ffe6; }
        #customMessageBox.danger { border-color: #dc3545; background-color: #ffe6e6; }

    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light py-3">
    <div class="container">
        <a class="navbar-brand fw-bold fs-3" href="#">Speechy<span class="text-primary">AI</span></a>
        <ul class="navbar-nav ms-auto align-items-center gap-3">
            <li class="nav-item"><a class="nav-link active" href="index.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="aifeedback.html">AIFeedback</a></li>
            <li class="nav-item"><a class="nav-link" href="http://13.250.114.125:8000/">AIìœ ì‚¬ë„ ë¶„ì„</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <h1>AIì™€ì˜ ë°œí‘œ ìœ ì‚¬ë„ ë¶„ì„</h1>
    <p>ë¹„êµí•  ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”. ì—…ë¡œë“œëœ íŒŒì¼ì€ í‘œì¤€ AI ìŒì„± íŒŒì¼ê³¼ ë¹„êµë©ë‹ˆë‹¤.</p>
    <input type="file" id="audioFileInput" accept="audio/*">

    <button onclick="generateWaveform()">ì—…ë¡œë“œëœ íŒŒì¼ íŒŒí˜• ë³´ê¸°</button>
    <button onclick="generateOverlappedWaveform()">ê²¹ì³ì§„ íŒŒí˜• ë³´ê¸°</button>
    <button onclick="uploadAndAnalyze()">ìœ ì‚¬ë„ ë¶„ì„ ì‹œì‘</button>
    <div id="loading" class="loading" style="display:none;">
        ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
    </div>

    <div id="standard-waveform-container" style="display:none;">
        <h2>í‘œì¤€ ì˜¤ë””ì˜¤ íŒŒí˜•</h2>
        <img id="standard-waveform-image" src="" alt="í‘œì¤€ ì˜¤ë””ì˜¤ íŒŒí˜•">
        <div id="standard-waveform-loading" class="loading" style="display:block;">
            í‘œì¤€ íŒŒí˜• ë¡œë”© ì¤‘...
        </div>
    </div>

    <div id="waveform-container" style="display:none;">
        <h2>ì—…ë¡œë“œëœ ì˜¤ë””ì˜¤ íŒŒí˜•</h2>
        <img id="waveform-image" src="" alt="ì—…ë¡œë“œëœ ì˜¤ë””ì˜¤ íŒŒí˜•">
    </div>

    <div id="overlapped-waveform-container" style="display:none;">
        <h2>ê²¹ì³ì§„ ì˜¤ë””ì˜¤ íŒŒí˜•</h2>
        <img id="overlapped-waveform-image" src="" alt="ê²¹ì³ì§„ ì˜¤ë””ì˜¤ íŒŒí˜•">
    </div>

    <div id="result" style="display:none;">
        <h2>ğŸ¤ ë°œí‘œ í”¼ë“œë°± ê²°ê³¼</h2>
        <p id="similarityScore" style="font-size: 22px; font-weight: bold;">ìœ ì‚¬ë„ ì ìˆ˜: -</p>
        <p id="feedbackMessage" style="font-size: 18px; color: #007bff;">ë©”ì‹œì§€: -</p>
        <p id="detail" style="color: #555;">ìƒì„¸ ë¶„ì„: -</p>
    </div>
</div>

<div id="customMessageBox" style="display:none;">
    <h3 id="customMessageTitle"></h3>
    <p id="customMessageContent"></p>
    <button onclick="this.parentNode.style.display='none'">í™•ì¸</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });
    });

    // Global variables to cache the overlapped waveform image and the file that generated it
    let cachedOverlappedImageUrl = null;
    let lastOverlappedFile = null;

    /**
     * Loads and displays the standard audio waveform image from the server.
     * @returns {Promise<boolean>} True if the waveform was loaded successfully, false otherwise.
     */
    async function loadStandardWaveform() {
        const standardWaveformContainer = document.getElementById('standard-waveform-container');
        const standardWaveformImage = document.getElementById('standard-waveform-image');
        const standardWaveformLoading = document.getElementById('standard-waveform-loading');

        // Show loading indicator and hide container initially
        standardWaveformLoading.style.display = 'block';
        standardWaveformContainer.style.display = 'none';
        standardWaveformImage.src = ''; // Clear previous image

        try {
            const response = await fetch('/get_standard_waveform');
            if (!response.ok) {
                const errorData = await response.json();
                console.error('Failed to load standard waveform:', errorData.detail || errorData.error || response.statusText);
                displayCustomMessage('ì˜¤ë¥˜', 'í‘œì¤€ íŒŒí˜•ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                return false;
            }
            const blob = await response.blob();
            const imageUrl = URL.createObjectURL(blob);
            standardWaveformImage.src = imageUrl;

            // Wait for the image to load before hiding the loading indicator
            await new Promise(resolve => { standardWaveformImage.onload = resolve; });

            standardWaveformLoading.style.display = 'none';
            standardWaveformContainer.style.display = 'block'; // Show container on success
            return true;

        } catch (error) {
            console.error('Error loading standard waveform:', error);
            displayCustomMessage('ì˜¤ë¥˜', `í‘œì¤€ íŒŒí˜•ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'danger');
            standardWaveformContainer.style.display = 'none';
            standardWaveformLoading.style.display = 'none';
            return false;
        }
    }

    /**
     * Uploads the selected audio file to the server for similarity analysis
     * and displays the feedback based on the similarity score.
     */
    async function uploadAndAnalyze() {
        const audioFileInput = document.getElementById('audioFileInput');
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const similarityScoreElem = document.getElementById('similarityScore');
        const feedbackMessageElem = document.getElementById('feedbackMessage');
        const detailElem = document.getElementById('detail');

        const file = audioFileInput.files?.[0];
        if (!file) {
            displayCustomMessage('ì•Œë¦¼', 'ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'info');
            return;
        }

        // Show loading indicator and hide previous results/waveforms
        loadingDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        document.getElementById('waveform-container').style.display = 'none';
        document.getElementById('standard-waveform-container').style.display = 'none';

        // Call generateOverlappedWaveform to show the overlapped waveform
        await generateOverlappedWaveform();

        const formData = new FormData();
        formData.append('audioFile', file);

        try {
            const response = await fetch('/upload_and_analyze', {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ');
            }

            const data = await response.json();
            const similarityScore = data.similarity_score;

            similarityScoreElem.textContent = `ìœ ì‚¬ë„ ì ìˆ˜: ${similarityScore.toFixed(4)}`;

            // Set feedback message based on similarity score
            let message = '';
            let detail = '';
            if (similarityScore >= 0.9) {
                message = 'âœ¨ ë°œì„±ì´ ì™„ë²½í•´ìš”! AI ìŒì„± ì›ë³¸ê³¼ ê±°ì˜ ë™ì¼í•©ë‹ˆë‹¤.';
                detail = 'ë§¤ìš° ì•ˆì •ì ì´ê³  ì •í™•í•œ ë°œìŒì„ êµ¬ì‚¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. í›Œë¥­í•©ë‹ˆë‹¤!';
            } else if (similarityScore >= 0.8) {
                message = 'ğŸ‘ ì•„ì£¼ ì˜í•˜ì…¨ì–´ìš”! ë°œì„±ì´ í›Œë¥­í•˜ê³  ìì—°ìŠ¤ëŸ½ìŠµë‹ˆë‹¤.';
                detail = 'ëŒ€ë¶€ë¶„ì˜ ìŒì ˆì´ AI ìŒì„± ì›ë³¸ê³¼ ì˜ ì¼ì¹˜í•˜ë©°, ì–µì–‘ê³¼ ê°•ì„¸ë„ ì¢‹ìŠµë‹ˆë‹¤.';
            } else if (similarityScore >= 0.7) {
                message = 'ğŸ˜„ ê´œì°®ì•„ìš”! ëŒ€ì²´ë¡œ ëª…í™•í•˜ì§€ë§Œ, ëª‡ êµ°ë° ê°œì„ í•  ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤.';
                detail = 'ì¼ë¶€ ë‹¨ì–´ë‚˜ êµ¬ì ˆì—ì„œ ë¯¸ì„¸í•œ ì°¨ì´ê°€ ë°œê²¬ë©ë‹ˆë‹¤. í•´ë‹¹ ë¶€ë¶„ì„ ì§‘ì¤‘ì ìœ¼ë¡œ ì—°ìŠµí•˜ë©´ ë” ì¢‹ì•„ì§ˆ ê±°ì˜ˆìš”.';
            } else if (similarityScore >= 0.6) {
                message = 'ğŸ™‚ ë…¸ë ¥í•´ë´…ì‹œë‹¤! ë°œìŒ ì •í™•ë„ë¥¼ ì¢€ ë” ë†’ì¼ í•„ìš”ê°€ ìˆì–´ìš”.';
                detail = 'ì „ë°˜ì ìœ¼ë¡œ ì´í•´ëŠ” ê°€ëŠ¥í•˜ë‚˜, ëª‡ëª‡ ë°œìŒì´ ëª…í™•í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì›ë³¸ ìŒì„±ì„ ë°˜ë³µí•´ì„œ ë“¤ì–´ë³´ì„¸ìš”.';
            } else {
                message = 'ğŸ˜… ë‹¤ì‹œ í•œë²ˆ ì‹œë„í•´ë³¼ê¹Œìš”? ì—°ìŠµì´ ë” í•„ìš”í•©ë‹ˆë‹¤.';
                detail = 'AI ìŒì„± ì›ë³¸ê³¼ì˜ ì°¨ì´ê°€ í¬ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ê° ë‹¨ì–´ì˜ ì •í™•í•œ ë°œìŒ ë° ì†ë„ë„ì— ì§‘ì¤‘í•˜ì—¬ ì—°ìŠµí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.';
            }

            feedbackMessageElem.textContent = `ë©”ì‹œì§€: ${message}`;
            detailElem.textContent = `ìƒì„¸ ë¶„ì„: ${detail}`;

            resultDiv.style.display = 'block';

        } catch (error) {
            console.error('Error:', error);
            displayCustomMessage('ì˜¤ë¥˜', `ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'danger');
            resultDiv.style.display = 'none';
        } finally {
            // Ensure loading indicator is hidden after all operations
            loadingDiv.style.display = 'none';
        }
    }

    /**
     * Generates and displays the waveform for the uploaded audio file.
     * Also loads the standard waveform for comparison.
     */
    async function generateWaveform() {
        const audioFileInput = document.getElementById('audioFileInput');
        const waveformContainer = document.getElementById('waveform-container');
        const waveformImage = document.getElementById('waveform-image');
        const loadingDiv = document.getElementById('loading');
        document.getElementById('result').style.display = 'none';
        document.getElementById('overlapped-waveform-container').style.display = 'none'; // Ensure overlapped is hidden

        const file = audioFileInput.files?.[0];
        if (!file) {
            displayCustomMessage('ì•Œë¦¼', 'ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'info');
            return;
        }

        // Show loading and hide waveform container initially
        loadingDiv.style.display = 'block';
        waveformContainer.style.display = 'none';
        waveformImage.src = '';

        // Load standard waveform first
        const standardWaveformLoaded = await loadStandardWaveform();
        if (!standardWaveformLoaded) {
            loadingDiv.style.display = 'none';
            return; // Stop if standard waveform failed to load
        }

        const formData = new FormData();
        formData.append('audioFile', file);

        try {
            const response = await fetch('/get_waveform', {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || errorData.error || 'íŒŒí˜• ë¡œë”© ì‹¤íŒ¨');
            }

            const blob = await response.blob();
            const imageUrl = URL.createObjectURL(blob);
            waveformImage.src = imageUrl;
            waveformContainer.style.display = 'block'; // Show uploaded waveform

        } catch (error) {
            console.error('Error generating waveform:', error);
            displayCustomMessage('ì˜¤ë¥˜', `íŒŒí˜•ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'danger');
            waveformContainer.style.display = 'none';
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    /**
     * Generates and displays an overlapped waveform image
     * showing the uploaded audio and the standard audio combined.
     * This function now caches the image to avoid re-fetching for the same file.
     */
    async function generateOverlappedWaveform() {
        const audioFileInput = document.getElementById('audioFileInput');
        const overlappedWaveformContainer = document.getElementById('overlapped-waveform-container');
        const overlappedWaveformImage = document.getElementById('overlapped-waveform-image');
        const loadingDiv = document.getElementById('loading');

        // Hide other result and waveform containers
        document.getElementById('result').style.display = 'none';
        document.getElementById('waveform-container').style.display = 'none';
        document.getElementById('standard-waveform-container').style.display = 'none';

        const file = audioFileInput.files?.[0];
        if (!file) {
            displayCustomMessage('ì•Œë¦¼', 'ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'info');
            return;
        }

        // Check if the current file is the same as the last one that generated an overlapped waveform
        // and if there's a cached image URL for it.
        // Using file.name and file.size for a simple check, more robust comparison might involve file hash.
        if (cachedOverlappedImageUrl && lastOverlappedFile &&
            lastOverlappedFile.name === file.name &&
            lastOverlappedFile.size === file.size) {
            overlappedWaveformImage.src = cachedOverlappedImageUrl;
            overlappedWaveformContainer.style.display = 'block';
            loadingDiv.style.display = 'none'; // Ensure loading is hidden if cached
            console.log('ìºì‹œëœ ê²¹ì³ì§„ íŒŒí˜• ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
            return; // Exit early as image is already displayed
        }

        // If not cached or file changed, proceed with fetching
        loadingDiv.style.display = 'block';
        overlappedWaveformContainer.style.display = 'none';
        overlappedWaveformImage.src = '';

        const formData = new FormData();
        formData.append('audioFile', file); // Node.js endpoint receives 'audioFile'

        try {
            const response = await fetch('/get_overlapped_waveform', { // Call Node.js new endpoint
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || errorData.error || 'ê²¹ì³ì§„ íŒŒí˜• ìƒì„± ì‹¤íŒ¨');
            }

            const blob = await response.blob();
            const imageUrl = URL.createObjectURL(blob);
            overlappedWaveformImage.src = imageUrl;
            overlappedWaveformContainer.style.display = 'block'; // Show overlapped waveform container

            // Cache the new image URL and the file object for future use
            cachedOverlappedImageUrl = imageUrl;
            lastOverlappedFile = file;
            console.log('ìƒˆë¡œìš´ ê²¹ì³ì§„ íŒŒí˜• ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì™€ ìºì‹œí–ˆìŠµë‹ˆë‹¤.');

        } catch (error) {
            console.error('Error generating overlapped waveform:', error);
            displayCustomMessage('ì˜¤ë¥˜', `ê²¹ì³ì§„ íŒŒí˜•ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'danger');
            overlappedWaveformContainer.style.display = 'none';
            // Clear cache on error to ensure a fresh fetch next time
            cachedOverlappedImageUrl = null;
            lastOverlappedFile = null;
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    /**
     * Displays a custom message box instead of the browser's native alert.
     * @param {string} title - The title of the message box.
     * @param {string} message - The main content message.
     * @param {string} type - The type of message ('info', 'success', 'danger') to influence styling.
     */
    function displayCustomMessage(title, message, type = 'info') {
        let messageBox = document.getElementById('customMessageBox');
        if (!messageBox) {
            // Create message box element if it doesn't exist
            messageBox = document.createElement('div');
            messageBox.id = 'customMessageBox';
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                max-width: 400px;
                text-align: center;
                display: none; /* Hidden by default */
                flex-direction: column;
                gap: 15px;
            `;
            document.body.appendChild(messageBox);

            // Add title element
            const messageTitle = document.createElement('h3');
            messageTitle.id = 'customMessageTitle';
            messageBox.appendChild(messageTitle);

            // Add content element
            const messageContent = document.createElement('p');
            messageContent.id = 'customMessageContent';
            messageBox.appendChild(messageContent);

            // Add close button
            const closeButton = document.createElement('button');
            closeButton.textContent = 'í™•ì¸';
            closeButton.onclick = () => messageBox.style.display = 'none'; // Hide on click
            closeButton.style.cssText = `
                background-color: #007bff;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin-top: 10px;
            `;
            messageBox.appendChild(closeButton);
        }

        // Set content and style based on parameters
        const titleElem = document.getElementById('customMessageTitle');
        const contentElem = document.getElementById('customMessageContent');
        titleElem.textContent = title;
        contentElem.textContent = message;

        let borderColor, backgroundColor;
        switch (type) {
            case 'info':
                borderColor = '#007bff';
                backgroundColor = '#e6f3ff';
                break;
            case 'success':
                borderColor = '#28a745';
                backgroundColor = '#e6ffe6';
                break;
            case 'danger':
                borderColor = '#dc3545';
                backgroundColor = '#ffe6e6';
                break;
            default:
                borderColor = '#007bff';
                backgroundColor = '#e6f3ff';
        }
        messageBox.style.borderColor = borderColor;
        messageBox.style.backgroundColor = backgroundColor;
        messageBox.style.border = `1px solid ${borderColor}`;

        messageBox.style.display = 'flex'; // Show the message box
    }

    // The line to load standard waveform on window load has been removed,
    // as it's now triggered by button clicks (e.g., generateWaveform).
    // window.onload = loadStandardWaveform;
</script>
</body>
</html>